# .github/workflows/deploy.yml
name: Build and Deploy on Server (ARI)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: Build & Deploy Blue/Green on VPS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Script via SSH (Build on Server)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Variables y Rutas
            APP_DIR="/home/deployer/ari"

            # 2. Preparación del Código: Clonar o Pull
            mkdir -p $APP_DIR/app_source

            if [ -d "$APP_DIR/app_source/.git" ]; then
                echo "Haciendo git pull en la fuente existente..."
                cd $APP_DIR/app_source
                git pull origin master
            else
                echo "Clonando el repositorio por primera vez..."
                git clone https://github.com/${{ github.repository }} $APP_DIR/app_source
                cd $APP_DIR/app_source
            fi

            # 3. Determinar el slot inactivo (USANDO PUERTOS 3000/3001)
            CURRENT_PRODUCTION=$(cat $APP_DIR/.env 2>/dev/null | grep CURRENT_PRODUCTION | cut -d'=' -f2 | tr -d '\r')

            if [ -z "$CURRENT_PRODUCTION" ] || [ "$CURRENT_PRODUCTION" == "ari-blue" ]; then
                INACTIVE_SLOT="ari-green"
                INACTIVE_PORT="3001" # Nuevo slot (el que vamos a activar)
                ACTIVE_PORT="3000"   # Slot actual (el que vamos a desactivar)
            else
                INACTIVE_SLOT="ari-blue"
                INACTIVE_PORT="3000" # Nuevo slot (el que vamos a activar)
                ACTIVE_PORT="3001"   # Slot actual (el que vamos a desactivar)
            fi

            echo "--- Despliegue Build on Server ---"
            echo "Slot inactivo/destino: $INACTIVE_SLOT en puerto $INACTIVE_PORT"

            # 4. Construir la imagen Docker en el VPS
            echo "Construyendo nueva imagen localmente..."
            docker build -t local-build:$INACTIVE_SLOT .

            # 5. Detener y Limpiar el Contenedor Antiguo
            echo "Deteniendo y eliminando contenedor antiguo $INACTIVE_SLOT"
            docker stop $INACTIVE_SLOT 2>/dev/null || true
            docker rm $INACTIVE_SLOT 2>/dev/null || true

            # 6. Iniciar nuevo contenedor (Mapeando a :80)
            echo "Iniciando nuevo contenedor $INACTIVE_SLOT en puerto $INACTIVE_PORT"
            docker run -d --name $INACTIVE_SLOT -p $INACTIVE_PORT:80 -e APP_COLOR=$INACTIVE_SLOT --restart unless-stopped local-build:$INACTIVE_SLOT

            echo "Esperando 15 segundos para que el contenedor inicie..."
            sleep 15

            # 7. SWAP DE NGINX (down/max_fails)
            echo "Realizando swap de Nginx: Activando $INACTIVE_SLOT y desactivando $CURRENT_PRODUCTION"

            UPSTREAM_CONF="upstream ari_app {
            server 127.0.0.1:$ACTIVE_PORT down;
            server 127.0.0.1:$INACTIVE_PORT max_fails=3 fail_timeout=5s;}"
            echo "$UPSTREAM_CONF" | sudo tee /etc/nginx/conf.d/ari_upstreams_master.conf > /dev/null

            sudo systemctl reload nginx

            # 8. Actualizar estado
            echo "Actualizando estado. Nuevo slot de producción: $INACTIVE_SLOT"
            echo "CURRENT_PRODUCTION=$INACTIVE_SLOT" > "$APP_DIR/.env"

            echo "¡Despliegue finalizado!"
